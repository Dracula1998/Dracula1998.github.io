# 安全协议笔记

### 一、PKI引言

##### 攻击类型

被动攻击，主动攻击

##### 安全需求

保密性，完整性，认证性，抗抵赖性，访问控制，可用性

##### 安全机制

加密：提供保密性，认证性和完整性保护

数字签名：提供认证性，完整性保护，抗抵赖性

校验和/哈希算法：提供完整性保护，认证性

#####  对称加密

块加密：加密固定大小的数据块

流加密：

##### 非对称加密

加密信息和验证签名的密钥不能用来解密和创建签名

作用：

​		密钥分发：如何在不存在KDC的情况下建立安全通信

​		数字签名：验证消息的发送者

应用：加密/解密、数字签名、密钥交换

##### 比较

* 对称加密的优点 
  * 速度快，处理量大，适用于对应用数据的直接加密
  * 加密密钥的长度相对较短
  * 除了加密，还可构造各种加密体制，如产生伪随机数，HASH函数等
  * 历史较长

* 对称加密的缺点
  * 密钥在双方都要保持一致，保密和传递较难
  * 大型网络中密钥量大，难以管理，一般需要TTP
  * 密钥需要经常更换

* 非对称加密的优点
  * 只有秘密玥保密，公密钥公开
  * 网络上只需要一个功能性的TTP，而不是一个绝对安全的TTP，不需要在线，可以离线
  * 密钥生命周期相对较长
  * 许多公钥方案可以产生数字签名机制
  * 在大型网络上，所需的密钥相对较少

* 非对称加密的缺点
  * 速度慢，处理量少，适用于密钥交换
  * 密钥长度相对较长
  * 安全性没有得到理论证明
  * 历史较短

##### Hash 函数

认证和抗抵赖：生成消息的Hash值，再对Hash值进行签名，与消		息一同发送

完整性，认证和保密性：

​		生成消息的Hash值，签名与消息一同加密后发送

##### MAC

认证和完整性保护：生成消息的mac值与消息一同发送

完整性，认证和保密性：

* 消息与生成的MAC值一同加密后发送
* 消息加密后生成MAC，并将MAC与加密后的消息一同发送

##### 数字签名

##### 密钥管理

两种密钥

* 短期会话密钥：自动的，不可见的 生成，用于一次消息或会话

* 长期密钥：明确地由用户生成

  ​	长期密钥的目的：认证（访问控制，完整性，抗否认性）、		保密性（建立会话密钥、保护存储的数据）

数字信封

##### PKI (Public Key Infrastructure)

### 二、PKI基础设施概念与框架

##### 公钥基础设施PKI

Public Key Infrastructure, PKI是一个用非对称密码算法原理和技术实现并提供全面安全服务的具有通用性的安全基础设施。是一种遵循标准的利用公钥技术为电子商务、电子政务的开展提供一整套安全解决方案的基础设施。

PKI采用数字证书机制管理公钥，通过第三方可信机构－CA，把用户的公开钥和身份信息进行有效捆绑，在Internet上验证用户的身份。通过数字证书，通过对要传输的信息进行加密和签名，保证信息传输的机密性、完整性、真实性、不可否认性，实现身份认证，从而全面保证信息安全传输。

##### 属性证书(Attribute Certificate)

采用数字签名技术将用户的身份信息和相关属性(如用户角色/权限等)进行有效捆绑形成的认证对象。通过与身份证书的结合使用，实现网络身份认证和访问控制。

##### PKI服务的认证性实现

前提：安全的获得对方的公开密钥

认证手段：

	* 公共可信时间环境中：请求信息签名方案
	* 防范重放攻击环境中：挑战信息签名方案

##### PKI服务的保密性实现

* 生成一个对称密钥
* 用对称密钥加密数据
* 加密后的数据发送给对方

##### PKI服务的不可否认性的实现

* 数字签名+时间戳服务
* 证据（原始数据+签名信息+密钥+时间戳）

##### PKI系统结构组成

* Certificate Authority(CA) &Registration Authority (RA)

  证书的申请和签发机构，是PKI的核心，是PKI应用中权威的、可信的、公正的第三方机构。

* Keys Backup & Recovery System

  对用户的解密密钥进行备份，当丢失时进行恢复，而签名密钥不能备份和恢复。

* Certificate Revocation System

  证书由于某种原因需要作废，终止使用，须将证书列入CRL中。

* Certificate Distribution System (CDS) or Repository(CR)

   证书的集中存放地，提供公众查询。

* End Entities and PKI application Interfaces

  为各种应用提供安全、一致、可信任的方式与PKI交互。

##### 认证中心CA

* 是PKI的信任基础，权威、可信的第三方TTP
* 基于数字签名技术，其签名公钥高效安全发布
* 高安全性和可用性
* 数字证书和密钥管理（全周期）

##### CA密钥管理

* CA签名密钥：用于签发用户证书，安全度最高，生命周期很长
* CA签名密钥更新

##### 用户密钥管理

* 密钥种类
  * 签名密钥对：由签名私玥/签名公钥组成。用于用户信息签名和验证签名。对应的证书称为签名证书。
  * 加密密钥对：由加密共钥/解密公钥组成。用于用户信息加密/解密，密钥交换等。对应的证书称为加密证书。

* 生成方式
  * 用户自己产生：一般指签名密钥对
  * CA密钥管理中心产生并分发：一般指加密密钥对

##### CA中心基本结构

一般三级结构

CA系统     签发管理   目录服务／数据库服务／OCSP服务／数字时戳服务

RA系统     注册登记        负责某一区域／行业

LRA系统   本地受理点    面向最终用户

##### RA中心

RA(Registry Authority)是数字证书注册审批机构，是CA管理功能的延伸。

负责证书申请者的信息录入、审核等工作。

证书介质管理：IC卡、USB－KEY、文件等

##### 略

### 三、证书和证书注销列表

##### ASN.1

基本思想是为描述书记结构而创建一种允许通过机器来产生数据编码解码器的系统

高层定义的结构描述规范，容易转换成为二进制形式

DER（Distinguished Encoding Rules）是ASN.1的一种从抽象标记到具体二进制转化的确定性编码

数字证书和证书注销俩表等相关对象采用ASN.1描述并采用DER编码方法进行编码

##### ASN.1 具体编码 略

##### 数字证书

使用数字签名原理将对象的身份和对象的公开玥有效捆绑

##### 基本证书结构和语义

##### 证书注销列表 CRL

* 增量CRL
  * 随着时间退役，注销证书逐渐增多，需要控制CRL下载及时性和下载规模
  * 采取发布周期内基准点外的增量机制

* 分段CRL和CRL发布点
  * 为了控制CRL规模扩大和下载集中的问题
  * 将证书序列号进行某种规则的分段，每段形成一个规模较小的CRL，并分布式发布
  * 用户证书中包含CRL发布点，指明要下载的CRL位置

##### * OCSP在线证书状态协议

* 解决CRL周期性发布机制存在的问题（及时性）
* 实时获取证书状态
* 协议的基本过程描述
  * 请求 协议版本/服务请求/目标证书标识/拓展项
  * 回复 版本/相应器名称/证书状态恢复/拓展/签名算法标识/签名
    * 证书状态回复：证书标识/证书状态值/回复有效期/扩展
    * 证书状态值：良好/已撤销/未知

##### 属性证书

* AA，Attribute Certificate Authority的缩写，即属性证书中心。它是一个为用户提供业务权限认证的可信赖的安全服务机构。由它为用户业务操作提供认证的属性证书，与身份证书配合，实现用户权限控制。

* 属性证书 中包含了用户身份（与身份证书中的身份相一致）、用户操作权限属性以及AA对其所做的数字签名。

* 采用属性证书实现权限控制是代替ACL(Access Control Lists)的另一种权限控制安全方案。

### 四、信任模型

##### 单一直接信任

##### 严格层次结构

##### 对等结构（交叉认证）(N个CA)

* 网状交叉认证：N(N-1)/2个交叉认证
* 桥式交叉认证：N个

##### 网状结构

##### 用户为中心的结构

##### 混合模型

### 五、公开密钥密码体制标准

##### PCKS（Public-Key Cryptography Standard）

略

### 六、认证中心标准

##### X509认证

* 简单认证
  * 用于安全性比较低的环境
  * 基于用户名/口令方式

* 强认证
  * 用于安全性要求比较高的环境
  * 使用数字证书

##### 简单认证

* 用户名/口令铭文认证传送
* 使用单项函数的保护
* 使用单向函数对口令进行Hash，传送Hash认证（容易遭遇重放攻击）
* 随机数挑战应答（服务端发送随机数，客户端传送用户名+口令+挑战字的Hash，避免了重放攻击，但是多了一次传输）
* 基于时间标识的认证（将随机挑战字变成时间戳，避免一次通信，但是时间很难同步）
* 基于Hash和对称加密的挑战字应答方法（将用户名+口令作为对称密钥，加密服务器发来的挑战字）

##### 强认证（采用公钥密码技术）

单向认证

双向认证

三向认证

##### PKIX系列标准

##### 证书政策CP与认证实施声明CPS

* CP描述了PKI各方面对用户强加的需求和标准  ，也就是目的在于说明参与者必须做什么.

* CPS描述了CA和参与者在既定环境下如何在过程和控制中实现对CP的要求达到满足，也就是其目的在于揭示参与者如何执行其功能和实现控制。

* 一个CP可以应用于多个CA，多个组织。

* 一个CPS只适用于一个CA，一个组织。

* 一个CA应支持多个CP，多个CA可能支持同一个CP。

* CPS的描述比CP更加细致。

##### 轻量级目录服务LDAP

* LDAP使用的数据模型有点类似于DNS：都是一个树形结构

* 每个资源都是这个树中的一个叶子结点

* Directory Information Tree(DIT)及其相关概念构成了LDAP使用的数据模型

* 树中的每个节点都是一个Entry(条目，入口)

* 某个条目本身有一个名称，称为Relative Distinguished Name(相关辨识名)。它被用来区别同级的其它条目

* 从某个入口到根的直接下级的RDN序列构成了该入口的Distinguished Name(辨识名)，用来在整个树中标识这个节点

##### LDAP在PKI中的应用

* 可以在许多应用中提供透明性要求，方便用户使用
* 不依赖底层的数据库系统，方便实现大规模分布式要求

##### Operational Protocols- FTP and HTTP 

* 该协议描述了用FTP和HTTP协议从证书和证书注销列表存储仓库（Repository）获取证书和证书注销列表的机制。

* 在证书和CRL的扩展项中,   使用URI 形式的  GeneralName 用来描述获取签发的证书和的位置. 

* Internet 用户可以把URI reference发布 到一个文件里，里面包含了他们的证书位置.

##### Online Certificate Status Protocol –OCSP 

##### Time Stamp Protocols -TSP

* 提供一个数据在某个时间之前的存在性证明
* 数字签名+时间戳 提供抗否认服务
* 基本原理：对数据的摘要和公正时间进行权威绑定，并可以验证
* 用户和时间戳认证中心（Time Stamping Authority，TSA)之间的交互协议

过程

* 时间戳请求者向时间戳认证中心发送请求（TimeStampReq）。

* 时间戳认证中心向时间戳请求者发送响应（TimeStampResp）。

* 时间戳请求者验证响应
  * 检查响应状态码（出错则失败）
  * 检查验证返回的时间戳（数字签名和各个域内容）
  * 检查TSA证书的有效性

##### 补：Cryptographic Message Syntax (CMS) 

* 该文档描述了密码消息语法，功能用于数字签名、摘要、认证和加密任意消息内容等。

* 描述了数据保护的封装语法，支持数字签名和加密。

* 允许多次封装即嵌套封装